name: Weather MLOps Pipeline

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ci-checks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: Lint (flake8)
        run: |
          flake8 . --max-line-length=120 --exclude .venv,.git,__pycache__,mlruns

      - name: Test with pytest (pass if no tests)
        run: |
          EXIT=0
          pytest -q || EXIT=$?
          if [ "$EXIT" -eq 5 ]; then
            echo "No tests collected. Passing."
            exit 0
          elif [ "$EXIT" -ne 0 ]; then
            exit $EXIT
          fi

  build-and-train:
    needs: ci-checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      DATA_SOURCE: repo            # 'repo' ใช้ data/ จาก repo, 'synthetic' สร้างใหม่
      DATA_PATH: data              # ค่าเริ่มต้นชี้ไปที่โฟลเดอร์ data ใน repo
      TARGET_SIZE_W: 128
      TARGET_SIZE_H: 128
      IMAGES_PER_CLASS: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare synthetic dataset for CI
        if: ${{ env.DATA_SOURCE == 'synthetic' }}
        run: |
          python scripts/00_prepare_dataset.py --data_path artifacts/raw_dataset --target_size ${{ env.TARGET_SIZE_W }} ${{ env.TARGET_SIZE_H }} --images_per_class ${{ env.IMAGES_PER_CLASS }}

      - name: Set DATA_PATH for synthetic
        if: ${{ env.DATA_SOURCE == 'synthetic' }}
        run: echo "DATA_PATH=artifacts/raw_dataset" >> $GITHUB_ENV

      - name: Set DATA_PATH for repo dataset
        if: ${{ env.DATA_SOURCE == 'repo' }}
        run: echo "DATA_PATH=data" >> $GITHUB_ENV

      - name: Run Data Validation
        run: |
          python scripts/01_data_validation.py --data_path ${{ env.DATA_PATH }} --output_path artifacts

      - name: Run Data Preprocessing
        id: preprocessing
        run: |
          python scripts/02_data_preprocessing.py --data_path ${{ env.DATA_PATH }} --output_path artifacts/processed_data --target_size ${{ env.TARGET_SIZE_W }} ${{ env.TARGET_SIZE_H }}

      - name: Run Model Training, Evaluation, and Registration
        run: |
          python scripts/03_train_evaluate_register.py --processed_data_path artifacts/processed_data --models_path models --artifacts_path artifacts --experiment_name CI-Pipeline --epochs 3 --models cnn

      - name: Transition Model to Staging
        run: |
          echo "(optional) transition handled in training script if registry enabled"

      - name: Upload models
        uses: actions/upload-artifact@v4
        with:
          name: models
          path: models/
          if-no-files-found: warn

      - name: Upload MLflow artifacts (skip if using remote tracking)
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts/
          if-no-files-found: warn

      - name: Upload MLflow runs
        uses: actions/upload-artifact@v4
        with:
          name: mlruns
          path: mlruns/
          if-no-files-found: warn